name: deploy-frontend

on:
  pull_request:
    branches:
      - main
  push:
    tags:
      - 'v*.*.*'

jobs:
  install:
    name: Install dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: packages/client/package-lock.json

      - name: Install dependencies (client)
        working-directory: packages/client
        run: npm ci

  lint:
    name: Lint code
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: packages/client/package-lock.json

      - name: Install dependencies (client)
        working-directory: packages/client
        run: npm ci

      - name: Run linter
        working-directory: packages/client
        run: npm run lint

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: packages/client/package-lock.json

      - name: Install dependencies (client)
        working-directory: packages/client
        run: npm ci

      - name: Run typecheck
        working-directory: packages/client
        run: npm run typecheck

  build:
    name: Build project
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: packages/client/package-lock.json

      - name: Install dependencies (client)
        working-directory: packages/client
        run: npm ci

      - name: Build project
        working-directory: packages/client
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: client-dist
          path: packages/client/dist
          retention-days: 1

  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: packages/client/package-lock.json

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Install jq
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Pull Vercel environment information
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel pull --yes --environment=production --token "$VERCEL_TOKEN"

      - name: Deploy project (remote build)
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          set +e
          vercel deploy --prod --yes --token "$VERCEL_TOKEN" --debug > deploy.log 2>&1
          DEPLOY_EXIT_CODE=$?
          cat deploy.log

          DEPLOY_URL=$(grep -Eo 'https://[a-zA-Z0-9.-]+\.vercel\.app' deploy.log | head -1)
          DEPLOY_ID=$(grep -Eo 'dpl_[a-zA-Z0-9]+' deploy.log | tail -1)

          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo "vercel deploy a échoué avec le code $DEPLOY_EXIT_CODE"
            exit $DEPLOY_EXIT_CODE
          fi

          if [ -z "$DEPLOY_URL" ] || [ -z "$DEPLOY_ID" ]; then
            echo "Impossible de récupérer les informations du déploiement."
            exit 1
          fi

          echo "Deployment URL: $DEPLOY_URL"
          echo "Deployment ID: $DEPLOY_ID"
          echo "deployment_url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          echo "deployment_id=$DEPLOY_ID" >> "$GITHUB_OUTPUT"

      - name: Vérifier le statut du déploiement via l'API Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment_id }}
        run: |
          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "DEPLOYMENT_ID introuvable."
            exit 1
          fi

          API_URL="https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID"
          echo "Surveillance du déploiement $DEPLOYMENT_ID via $API_URL"

          MAX_ATTEMPTS=60
          SLEEP_SECONDS=10

          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            RESPONSE=$(curl -sf -H "Authorization: Bearer $VERCEL_TOKEN" "$API_URL")
            echo "$RESPONSE"

            STATE=$(echo "$RESPONSE" | jq -r '.readyState // empty')

            if [ -z "$STATE" ] || [ "$STATE" = "null" ]; then
              echo "Impossible de récupérer l'état du déploiement. Nouvelle tentative dans $SLEEP_SECONDS secondes..."
              sleep $SLEEP_SECONDS
              continue
            fi

            echo "État actuel: $STATE"

            case "$STATE" in
              READY)
                echo "Déploiement réussi"
                exit 0
                ;;
              ERROR|FAILED|CANCELED|CANCELLED)
                echo "Déploiement échoué avec l'état: $STATE"
                exit 1
                ;;
              BUILDING|QUEUED|INITIALIZING|BOOTING|PENDING)
                echo "Déploiement en cours. Attente de $SLEEP_SECONDS secondes..."
                sleep $SLEEP_SECONDS
                ;;
              *)
                echo "État inattendu: $STATE. Attente de $SLEEP_SECONDS secondes..."
                sleep $SLEEP_SECONDS
                ;;
            esac
          done

          echo "Timeout: le déploiement n'est pas READY après $((MAX_ATTEMPTS * SLEEP_SECONDS)) secondes."
          exit 1

