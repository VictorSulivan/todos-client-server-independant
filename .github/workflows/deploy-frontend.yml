name: deploy-frontend

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy-vercel:
    name: Deploy frontend to Vercel
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Git for Vercel
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
          cache-dependency-path: packages/client/package-lock.json

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Install jq
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Install dependencies
        working-directory: packages/client
        run: npm ci

      - name: Pull Vercel Environment Information
        working-directory: packages/client
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel pull --yes --environment=production --token "$VERCEL_TOKEN"

      - name: Deploy to Vercel (trigger remote build)
        id: deploy
        working-directory: packages/client
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          DEPLOY_RESPONSE=$(vercel deploy --prod --yes --confirm --token "$VERCEL_TOKEN" --json)
          echo "$DEPLOY_RESPONSE"
          DEPLOY_URL=$(echo "$DEPLOY_RESPONSE" | jq -r '.url // empty')
          if [ -z "$DEPLOY_URL" ] || [ "$DEPLOY_URL" = "null" ]; then
            echo "Impossible de r√©cup√©rer l'URL du d√©ploiement."
            exit 1
          fi
          echo "Deployment URL: https://$DEPLOY_URL"
          echo "deployment_url=https://$DEPLOY_URL" >> "$GITHUB_OUTPUT"

      - name: V√©rifier le statut du d√©ploiement
        working-directory: packages/client
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          DEPLOYMENT_URL="${{ steps.deploy.outputs.deployment_url }}"
          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "URL du d√©ploiement introuvable."
            exit 1
          fi

          echo "Surveillance du d√©ploiement $DEPLOYMENT_URL"
          MAX_ATTEMPTS=60
          SLEEP_SECONDS=10

          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            INSPECT_RESPONSE=$(vercel inspect "$DEPLOYMENT_URL" --token "$VERCEL_TOKEN" --json || true)
            echo "$INSPECT_RESPONSE"

            STATE=$(echo "$INSPECT_RESPONSE" | jq -r '.deployment.readyState // .deployment.state // empty')

            if [ -z "$STATE" ] || [ "$STATE" = "null" ]; then
              echo "Impossible de r√©cup√©rer l'√©tat du d√©ploiement. Nouvelle tentative dans $SLEEP_SECONDS secondes..."
              sleep $SLEEP_SECONDS
              continue
            fi

            echo "√âtat actuel: $STATE"

            case "$STATE" in
              READY)
                echo "D√©ploiement r√©ussi üéâ"
                exit 0
                ;;
              ERROR|FAILED|CANCELED|CANCELLED)
                echo "D√©ploiement √©chou√© avec l'√©tat: $STATE"
                exit 1
                ;;
              BUILDING|QUEUED|INITIALIZING|BOOTING)
                echo "D√©ploiement en cours. Attente de $SLEEP_SECONDS secondes..."
                sleep $SLEEP_SECONDS
                ;;
              *)
                echo "√âtat inattendu: $STATE. Attente de $SLEEP_SECONDS secondes..."
                sleep $SLEEP_SECONDS
                ;;
            esac
          done

          echo "Timeout: le d√©ploiement n'est pas READY apr√®s $((MAX_ATTEMPTS * SLEEP_SECONDS)) secondes."
          exit 1

